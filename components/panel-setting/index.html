<polymer-element name="panel-setting" attributes="config">
    <template>
        <style>
            :host {
                display: block;
                height: 100vh;
                width: 100%;
            }

            .setting {
                height: 100vh;
                padding: 0 1vw;
                overflow: auto;
                font-size: 12px;
            }

            section {
                margin:5vh 0;
            }

            h3 {
                margin: 0;
                padding: 1vw;
                border-bottom: 1px solid;
                text-align: right;
            }

            h3 i {
                font-style: normal;
                color: orangered;
                cursor: pointer;
                vertical-align: 1px;
            }

            section div {
                margin-top: 5vh;
            }

            p {
                display: block;
                margin: 2vh 0;
            }

            p label{
                display: inline-block;
                width: 40% ;
                margin-right: 5%;
                text-align: right;
            }

            input {
                width: 50%;
                height: 20px;
                line-height: 20px;
                border: 1px solid rgba(0,0,0,0.2);
                background: rgba(255,255,255,0.4);
                text-indent: 5px;
                outline: none;
            }

            input:focus {
                background: rgba(255,255,255,0.8);
            }

            input[type="checkbox"] {
                width: auto;
                vertical-align: middle;
            }

            .backup {
                text-align: center;
                padding-bottom: 10vh;
            }

            button {
                width: 80px;
                height: 25px;
                margin: 0 2vw;
                border:1px solid rgba(100,100,100,0.1);
                background: rgba(255,255,255,0.4);
                cursor: pointer;
            }

            button:hover, button:focus {
                outline: none;
                background: rgba(255,255,255,0.8);
            }
        </style>
        <div class="setting">
            <section class="hot-key">
                <h3>热键设置</h3>
                <div>
                    <p>
                        <label>暂停/播放</label>
                        <input  name="PAUSE" placeholder="无" on-keydown="{{recordKey}}" on-blur="{{setKey}}" value="{{config.hotKey.PAUSE}}" />
                    </p>
                    <p>
                        <label>红心</label>
                        <input name="STAR" placeholder="无" on-keydown="{{recordKey}}" on-blur="{{setKey}}" value="{{config.hotKey.STAR}}" />
                    </p>
                    <p>
                        <label>不再播放</label>
                        <input name="NOPLAY" placeholder="无" on-keydown="{{recordKey}}" on-blur="{{setKey}}" value="{{config.hotKey.NOPLAY}}" />
                    </p>
                    <p>
                        <label>上一首</label>
                        <input name="PREV" placeholder="无" on-keydown="{{recordKey}}" on-blur="{{setKey}}" value="{{config.hotKey.PREV}}" />
                    </p>
                    <p>
                        <label>下一首</label>
                        <input name="NEXT" placeholder="无" on-keydown="{{recordKey}}" on-blur="{{setKey}}" value="{{config.hotKey.NEXT}}" />
                    </p>
                    <p>
                        <label>增加音量</label>
                        <input name="VOLUP" placeholder="无" on-keydown="{{recordKey}}" on-blur="{{setKey}}" value="{{config.hotKey.VOLUP}}" />
                    </p>
                    <p>
                        <label>减小音量</label>
                        <input name="VOLDOWN" placeholder="无" on-keydown="{{recordKey}}" on-blur="{{setKey}}" value="{{config.hotKey.VOLDOWN}}" />
                    </p>
                    <p>
                        <label>收听相似歌曲</label>
                        <input name="PLAY_SIMILAR" placeholder="无" on-keydown="{{recordKey}}" on-blur="{{setKey}}" value="{{config.hotKey.PLAY_SIMILAR}}" />
                    </p>
                    <p>
                        <label>打开播放列表</label>
                        <input name="PLAYLIST_SHOW" placeholder="无" on-keydown="{{recordKey}}" on-blur="{{setKey}}" value="{{config.hotKey.PLAYLIST_SHOW}}" />
                    </p>
                    <p>
                        <label>打开控制台</label>
                        <input name="SHOW_DEV_TOOLS" placeholder="无" on-keydown="{{recordKey}}" on-blur="{{setKey}}" value="{{config.hotKey.SHOW_DEV_TOOLS}}" />
                    </p>
                    <p>
                        <label>显示主窗口</label>
                        <input name="SHOW_WINDOW" placeholder="无" on-keydown="{{recordKey}}" on-blur="{{setKey}}" value="{{config.hotKey.SHOW_WINDOW}}" />
                    </p>
                    <p>
                        <label>重启客户端</label>
                        <input name="RESTART" placeholder="无" on-keydown="{{recordKey}}" on-blur="{{setKey}}" value="{{config.hotKey.RESTART}}" />
                    </p>
                    <p>
                        <label>退出客户端</label>
                        <input name="QUIT" placeholder="无" on-keydown="{{recordKey}}" on-blur="{{setKey}}" value="{{config.hotKey.QUIT}}" />
                    </p>
                    <p>
                        <label>显示歌词</label>
                        <input name="SHOW_LRC" placeholder="无" on-keydown="{{recordKey}}" on-blur="{{setKey}}" value="{{config.hotKey.SHOW_LRC}} " />
                    </p>
                    <p>
                        <label>打开豆瓣页面</label>
                        <input name="GOTO_DOUBAN" placeholder="无" on-keydown="{{recordKey}}" on-blur="{{setKey}}" value="{{config.hotKey.GOTO_DOUBAN}} " />
                    </p>
                    <p>
                        <label for="mideaKey">启用媒体键</label><input type="checkbox" name="mediaKey"  checked="{{config.mediaKey}}" on-change="{{toggle}}" />
                    </p>
                </div>
            </section>
            <section>
                <h3>其他设置</h3>
                <div>
                    <p>
                        <label for="wheelVolume">滚轮调节音量</label>
                        <input type="checkbox" name="wheelVolume" checked="{{config.wheelVolume}}" on-change="{{toggle}}"/>
                    </p>
                    <p>
                        <label for="lyric">显示歌词</label>
                        <input type="checkbox" name="lyric" checked="{{config.lyric}}" on-change="{{toggle}}" />
                    </p>
                    <p>
                        <label for="notification">启用桌面通知</label>
                        <input type="checkbox" name="notification" checked="{{config.notification}}" on-change="{{toggle}}"/>
                    </p>
                    <p>
                        <label>桌面通知时长</label>
                        <input name="notiTime" placeholder="单位秒" type=number min="0" max="6" value="{{config.notiTime}}" on-blur="{{setNotiTime}}" title="注意：修改通知显示时间后，桌面通知可能不会保存在系统的信息栏" />
                    </p>
                    <!--<p>-->
                        <!--<label>界面字体设置</label>-->
                        <!--<input name="fontfamily" placeholder="输入字体名称" title="可以输入多个，以逗号分割，按照从前到后的顺序，如果系统中没有前面的字体，则应用后面的" value="{{config.fontfamily}}" on-blur="{{setFontFamily}}" />-->
                    <!--</p>-->
                </div>
            </section>
        </div>
    </template>
    <script src="./keymap.js"></script>
    <script>
    Polymer('panel-setting',{
        config : FM.config,
        ready : function() {
            var self = this
            self.applyFontFamily()

            //FM.config变化后，记录到缓存
            FM.obs.on('CONFIG:UPDATE', function(e) {
                self.config = FM.config
                FM.cache.set('CACHE:CONFIG', FM.config)
            })

            FM.obs.on('KEY:REGISTER_FAIL', function(e) {
                delete FM.config.hotKey[e.name]
                FM.cache.set('CACHE:CONFIG', FM.config)
            })
        },

        //记录快捷键
        recordKey : function(e) {
            var self = this
            var target = e.currentTarget
            var key = self.getPressKey(e).trim()
            if(key == 'tab') return
            target.value = key
            target.dataset.key = key
        },

        //失去焦点后设置快捷键
        setKey : function(e) {
            var self = this
            var target = e.currentTarget
            var name = target.name
            var key = target.dataset.key
            if(key == 'tab') return
            if(key  && (key != FM.config.hotKey[name])) {
                FM.config.hotKey[name] = key
                FM.obs.emit('CONFIG:UPDATE', {type : 'hotKey', name : name, key : key})
            }
        },

        //获取快捷键组合
        getPressKey : function(e) {
            var keys = []
            var map = KeyMap.map
            if(e.metaKey) {
               keys.push(map[91][0])
            }
            if(e.shiftKey) {
                keys.push(map[16][0])
            }
            if(e.ctrlKey) {
                keys.push(map[17][0])
            }
            if(e.altKey) {
                keys.push(map[18][0])
            }
            if(e.keyCode && [16,17,18,91,92].indexOf(e.keyCode) < 0) {
                if(map[e.keyCode]) {
                    keys.push(map[e.keyCode][0])
                }
            }
            keys.forEach(function(o, i) {
                var s = o.split('')
                s[0] = s[0].toLowerCase()
                keys[i] = s.join('')
            })
            return keys.join('+')
        },

        //切换开关状态
        toggle : function(e) {
            var target = e.currentTarget
            var name = target.name
            FM.config[name]= target.checked
            FM.obs.emit('CONFIG:UPDATE', {type : name})
        },

        //应用字体设置
        applyFontFamily : function() {
            if(FM.config.fontfamily) {
                document.body.style.fontFamily = this.formatFontFamily(FM.config.fontfamily)
            }
        },

        //格式化中文字体为unicode字符
        formatFontFamily : function(fontfamily) {
            fontfamily =  fontfamily.replace(/['"]?([^\u0000-\u007F]+)['"]?/g, function ($0, zh) {
                var unicodeName = ''
                zh.split('').forEach(function(o, i) {
                    unicodeName += '\\' + o.charCodeAt(0).toString(16)
                })
                return '"' + unicodeName + '"'
            });
            return fontfamily
        },

        //保存字体设置
        setFontFamily : function(e) {
            var target = e.currentTarget
            this.applyFontFamily()
            FM.obs.emit('CONFIG:UPDATE', {type: target.name})
        },

        //保存桌面通知时间设置
        setNotiTime : function(e) {
            var target = e.currentTarget
            var time = parseFloat(target.value)
            if(isNaN(time) || time < 0) {
                target.value = ''
                return
            }
            FM.obs.emit('CONFIG:UPDATE', {type: target.name})
        }
    })
    </script>
</polymer-element>
